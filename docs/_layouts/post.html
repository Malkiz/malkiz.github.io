---
layout: default
---
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">{{ page.title | escape }}</h1>
    <div class="post-meta">
      {%- assign date_format = site.minima.date_format | default: "%b %-d, %Y" -%}
      {% assign pdate = page.date | date_to_xmlschema %}
      {%- if page.modified_date %}<span class="meta-label">Published:</span>{% endif %}
      <time class="dt-published" datetime="{{ pdate }}" itemprop="datePublished">
        {{ pdate | date: date_format }}
      </time>
      {%- if page.modified_date -%}
        <span class="bullet-divider">â€¢</span>
        <span class="meta-label">Updated:</span>
        {%- assign mdate = page.modified_date | date_to_xmlschema %}
        <time class="dt-modified" datetime="{{ mdate }}" itemprop="dateModified">
          {{ mdate | date: date_format }}
        </time>
      {%- endif -%}
      {%- if page.author %}
      <div class="{% unless page.modified_date %}force-inline {% endunless %}post-authors">
        {%- for author in page.author %}
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">{{ author }}</span></span>
          {%- if forloop.last == false %}, {% endif -%}
        {% endfor %}
      </div>
      {%- endif %}
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    {{ content }}
  </div>

  <div id="comments">
    <hr>
    <h3>Comments</h3>
    <div id="comments-list"></div>
    <form id="comment-form" method="POST" action="{{ site.apps_script_url }}">
      <input type="hidden" name="post" value="{{ page.url | absolute_url }}">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required><br>
      <label for="comment">Comment:</label>
      <textarea id="comment" name="comment" required></textarea><br>
      <button type="submit">Submit Comment</button>
    </form>
  </div>

  <a class="u-url" href="{{ page.url | relative_url }}" hidden></a>
</article>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const commentsList = document.getElementById('comments-list');
    const commentForm = document.getElementById('comment-form');
    const appsScriptUrl = '{{ site.apps_script_url }}';

    function sanitizeHTML(str) {
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }

    // Function to fetch and display comments
    const fetchComments = async () => {
      try {
        const currentPostUrl = '{{ page.url | absolute_url }}';
        const urlWithParams = `${appsScriptUrl}?post=${encodeURIComponent(currentPostUrl)}`;
        const response = await fetch(urlWithParams);
        const data = await response.json();
        const comments = data.data;

        commentsList.innerHTML = ''; // Clear previous comments

        const filteredComments = comments.filter(comment => comment.post === currentPostUrl);

        if (filteredComments.length > 0) {
          filteredComments.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.innerHTML = `
              <strong>${sanitizeHTML(comment.name)}</strong> on ${new Date(sanitizeHTML(comment.timestamp)).toLocaleDateString()}<br>
              <p>${sanitizeHTML(comment.comment)}</p>
              <hr>
            `;
            commentsList.appendChild(commentDiv);
          });
        } else {
          commentsList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
        }
      } catch (error) {
        console.error('Error fetching comments:', error);
      }
    };

    // Handle form submission
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new URLSearchParams(new FormData(commentForm));

      try {
        const response = await fetch(appsScriptUrl, {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          alert('Comment submitted successfully! It may take a moment to appear.');
          commentForm.reset();
          fetchComments(); // Refresh comments list
        } else {
          alert('Error submitting comment.');
        }
      } catch (error) {
        console.error('Submission error:', error);
      }
    });

    // Initial fetch of comments
    fetchComments();
  });
</script>
