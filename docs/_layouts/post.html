---
layout: default
---
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">{{ page.title | escape }}</h1>
    <div class="post-meta">
      {%- assign date_format = site.minima.date_format | default: "%b %-d, %Y" -%}
      {% assign pdate = page.date | date_to_xmlschema %}
      {%- if page.modified_date %}<span class="meta-label">Published:</span>{% endif %}
      <time class="dt-published" datetime="{{ pdate }}" itemprop="datePublished">
        {{ pdate | date: date_format }}
      </time>
      {%- if page.modified_date -%}
        <span class="bullet-divider">â€¢</span>
        <span class="meta-label">Updated:</span>
        {%- assign mdate = page.modified_date | date_to_xmlschema %}
        <time class="dt-modified" datetime="{{ mdate }}" itemprop="dateModified">
          {{ mdate | date: date_format }}
        </time>
      {%- endif -%}
      {%- if page.author %}
      <div class="{% unless page.modified_date %}force-inline {% endunless %}post-authors">
        {%- for author in page.author %}
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">{{ author }}</span></span>
          {%- if forloop.last == false %}, {% endif -%}
        {% endfor %}
      </div>
      {%- endif %}
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    {{ content }}
  </div>

  <!-- Comments Section -->
  <div id="comments-section">
    <hr>
    <h2>Comments</h2>

    <!-- Comments List -->
    <div id="comments-list" style="padding-left: 1rem;">
      <!-- Comments will be loaded here by JavaScript -->
      <p id="loading-message">Loading comments...</p>
    </div>

    <!-- Add New Comment Form -->
    <h3>Add a New Comment</h3>
    <form id="comment-form">
      <div>
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
      </div>
      <div>
        <label for="comment">Comment:</label>
        <textarea id="comment-text" name="comment" rows="5" required style="width: 100%;"></textarea>
      </div>
      <input type="hidden" id="post" name="post" value="{{ page.url | absolute_url }}">

      <button type="submit">
        Submit Comment
      </button>
    </form>

    <div id="status-message"></div>
  </div>

  <a class="u-url" href="{{ page.url | relative_url }}" hidden></a>
</article>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const commentsList = document.getElementById('comments-list');
    const commentForm = document.getElementById('comment-form');
    const statusMessage = document.getElementById('status-message');
    const appsScriptUrl = '{{ site.apps_script_url }}';

    // Function to fetch and display comments
    const fetchComments = async () => {
      try {
        const currentPostUrl = '{{ page.url | absolute_url }}';
        const urlWithParams = `${appsScriptUrl}?post=${encodeURIComponent(currentPostUrl)}`;
        const response = await fetch(urlWithParams);
        const data = await response.json();
        const comments = data.data;

        commentsList.innerHTML = ''; // Clear previous comments

        const filteredComments = comments.filter(comment => comment.post === currentPostUrl);

        if (filteredComments.length > 0) {
          filteredComments.forEach(comment => {
            const commentDiv = document.createElement('div');

            const name = document.createElement('strong');
            name.textContent = comment.name;
            const date = document.createElement('span');
            date.textContent = new Date(comment.timestamp).toLocaleDateString();
            const nameAndDate = document.createElement('p');
            nameAndDate.appendChild(name);
            nameAndDate.appendChild(document.createTextNode(' on '));
            nameAndDate.appendChild(date);

            const commentText = document.createElement('p');
            commentText.style = 'padding-left: 1rem;';
            commentText.textContent = comment.comment;

            commentDiv.appendChild(nameAndDate);
            commentDiv.appendChild(commentText);
            commentsList.appendChild(commentDiv);
          });
        } else {
          commentsList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
        }
      } catch (error) {
        console.error('Error fetching comments:', error);
      }
    };

    const nameInput = document.getElementById('name');
    const commentTextarea = document.getElementById('comment-text');
    const submitButton = commentForm.querySelector('#comment-form button[type="submit"]');

    // Handle form submission
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new URLSearchParams(new FormData(commentForm));

      // Disable the fields and button
      nameInput.disabled = true;
      commentTextarea.disabled = true;
      submitButton.disabled = true;

      statusMessage.textContent = 'Submitting...';

      try {
        const response = await fetch(appsScriptUrl, {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          statusMessage.textContent = 'Comment submitted successfully! It may take a moment to appear.';
          commentForm.reset();
          fetchComments(); // Refresh comments list
        } else {
          statusMessage.textContent = 'Error submitting comment. Please try again later.';
        }
      } catch (error) {
        console.error('Submission error:', error);
      } finally {
        // Re-enable the fields and button
        nameInput.disabled = false;
        commentTextarea.disabled = false;
        submitButton.disabled = false;
      }
    });

    // Initial fetch of comments
    fetchComments();
  });
</script>
